services:
  app:
    image: neexus/kairos:latest
    ports:
      - "4000:4000"

    # Raise FD limits inside the container (fixes ~900-1000 WS ceiling)
    ulimits:
      nofile:
        soft: 200000
        hard: 200000

    # Optional: container-scoped sysctls (safe + relevant for many connections)
    sysctls:
      net.core.somaxconn: "16384"
      net.ipv4.ip_local_port_range: "1024 65535"
      net.ipv4.tcp_max_syn_backlog: "8192"
      net.ipv4.tcp_tw_reuse: "1"

    # If your app needs to reach something on the host machine
    # (On Linux VPS you usually do NOT need this; keep only if you truly use it)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    environment:
      # Phoenix / Server Settings
      PHX_SERVER: "true"
      PHX_HOST: "localhost"
      PORT: "4000"
      SECRET_KEY_BASE: "your_secret_key_at_least_64_chars_long"
      CHECK_ORIGIN: "http://localhost:3000,http://localhost:4000"

      # Database Connection (Individual vars for WalListener)
      HOSTNAME: <host_address>
      DBUSERNAME: <username>
      PASSWORD: <password>
      DATABASE: <database_name>
      DBPORT: <port>
      SLOT: <slot_name_for_wal2json>
      POOL_SIZE: 40
      MAX_CONCURRENCY: 80
      BATCH_SIZE: 200
      CHUNK_SIZE: 50
      AUTH_SECRET: "qwertyuiopasdfghjklzxcvbnm123456"
      AUTH_ENABLED: "true"
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:3002
      WEBSOCKET_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:3002
      ENABLE_POSTGRES: true
      FILTER_TABLES: "\"add-tables\" 'public.users, public.posts'"
      NEXUS_DATABASE: "postgresql"
      FLUSH_INTERVAL: "2000"
      

      # Ecto Repo Connection
      DATABASE_URL: "postgres://<username>:<password>@<host_address>:<port>/<database_name>"


  debeziumm:
    image: quay.io/debezium/server:3.1.1.Final
    container_name: debezium_server
    # Needed to talk to your host machine's port 4000
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # SINK
      - DEBEZIUM_SINK_TYPE=http
      - DEBEZIUM_SINK_HTTP_URL=http://<address_to_server>:4000/realtime/d

      # SOURCE
      - DEBEZIUM_SOURCE_CONNECTOR_CLASS=io.debezium.connector.postgresql.PostgresConnector
      - DEBEZIUM_SOURCE_DATABASE_HOSTNAME=<host_address>
      - DEBEZIUM_SOURCE_DATABASE_PORT=<port>
      - DEBEZIUM_SOURCE_DATABASE_USER=<username>
      - DEBEZIUM_SOURCE_DATABASE_PASSWORD=<password>
      - DEBEZIUM_SOURCE_DATABASE_DBNAME=<database_name>
      - DEBEZIUM_SOURCE_PLUGIN_NAME=pgoutput
      - DEBEZIUM_SOURCE_PUBLICATION_NAME=<name_of_publication>
      - DEBEZIUM_SOURCE_TOPIC_PREFIX=source
      - DEBEZIUM_SOURCE_TABLE_INCLUDE_LIST=public.*
      - DEBEZIUM_SOURCE_SNAPSHOT_MODE=never   # if you truly want no snapshot

      # SMTs (unwrap)
      - DEBEZIUM_TRANSFORMS=unwrap
      - DEBEZIUM_TRANSFORMS_UNWRAP_TYPE=io.debezium.transforms.ExtractNewRecordState
      - DEBEZIUM_TRANSFORMS_UNWRAP_DELETE_HANDLING_MODE=rewrite
      - DEBEZIUM_TRANSFORMS_UNWRAP_ADD_FIELDS=op
      - DEBEZIUM_TRANSFORMS_UNWRAP_DROP_TOMBSTONES=true

      # FORMAT
      - DEBEZIUM_FORMAT_KEY=json
      - DEBEZIUM_FORMAT_KEY_SCHEMAS_ENABLE=true
      - DEBEZIUM_FORMAT_VALUE=json
      - DEBEZIUM_FORMAT_VALUE_SCHEMAS_ENABLE=true
      
      - DEBEZIUM_SINK_HTTP_BATCHING_ENABLED=true
      - DEBEZIUM_SINK_HTTP_BATCHING_MAX_SIZE=500
      - DEBEZIUM_SOURCE_POLL_INTERVAL_MS=1000
      - DEBEZIUM_SOURCE_MAX_BATCH_SIZE=2048
      - DEBEZIUM_SOURCE_MAX_QUEUE_SIZE=8192

      # OFFSETS
      - DEBEZIUM_SOURCE_OFFSET_STORAGE_FILE_FILENAME=/debezium/data/offsets.dat
    volumes:
      - ./data:/debezium/data



